# Skrift CMS - Code Audit Report

**Date:** 2026-02-15
**Codebase:** Skrift CMS v0.1.0a25
**Scope:** DRY, SOLID, cyclomatic complexity, security, architecture, testing

## Executive Summary

Skrift is a well-architected async Python CMS (~10K LOC) with strong design patterns (hooks system, template resolver, guard pattern). The main weaknesses are **security vulnerabilities** in auth flows, **significant DRY violations** in OAuth logic, **missing test coverage** for critical paths, and **high-complexity god functions**.

**Overall Score: 3.5/5** — Solid foundation, needs targeted improvements.

---

## 1. Security

| Severity | Issue | Location |
|----------|-------|----------|
| **HIGH** | Stored XSS via `{{ page.content \| markdown \| safe }}` — markdown-it-py allows raw HTML by default | `templates/page.html:17` |
| **HIGH** | Auto-linking OAuth accounts by email without verification enables account takeover | `controllers/auth.py:429-451` |
| **MEDIUM** | `X-Forwarded-For` trusted without proxy validation — rate limits bypassable | `middleware/rate_limit.py:38-47` |
| **MEDIUM** | Page edit/delete checks permission but not ownership (IDOR) | `admin/controller.py:289-330` |
| **MEDIUM** | `datetime.fromisoformat()` called without try/except — crashes on bad input | `admin/controller.py:252` |
| **MEDIUM** | Setup wizard re-accessible if `setup_completed_at` setting is corrupted | `setup/controller.py:88` |
| **MEDIUM** | CSP uses `'unsafe-inline'` for styles despite nonce support being implemented | `config.py:153` |
| **LOW** | OAuth `provider_metadata` stores full provider response — unnecessary data retention | `db/models/oauth_account.py:37` |
| **LOW** | Session rotation on login clears session but relies on backend for ID regeneration | `controllers/auth.py:277` |

### Dummy Auth Provider — NOT VULNERABLE

The dummy auth provider is properly guarded:
- Production `app.yaml` does not include the dummy provider.
- `app.dev.yaml` includes it only for local development.
- `validate_no_dummy_auth_in_production()` (`setup/providers.py:179-208`) is called at startup in both `create_app()` and `create_dispatcher()` (`asgi.py:433-435, 735-737`). If the environment is `production` and dummy is configured, the server **refuses to start** with a security error.

### Top 3 Immediate Fixes

1. Disable raw HTML in markdown-it-py or sanitize output before marking as `| safe`
2. Require email verification before auto-linking OAuth accounts to existing users
3. Add try/except around `datetime.fromisoformat()` in admin form handling

---

## 2. DRY Violations

| Severity | Duplication | Files | ~Lines Saved |
|----------|-------------|-------|-------------|
| **HIGH** | OAuth account creation/update logic (3 scenarios) duplicated verbatim | `auth.py` + `setup/controller.py` | ~120 |
| **HIGH** | Page form data extraction (11 fields) copy-pasted | `admin/controller.py:244-259, 322-337` | ~16 |
| **HIGH** | Session config + template/static config duplicated across both apps | `asgi.py:466-474, 596-635` | ~40 |
| **MEDIUM** | Flash + context boilerplate repeated in 12+ admin endpoints | `admin/controller.py` | ~60 |
| **MEDIUM** | Page-not-found + redirect pattern repeated 5+ times | `admin/controller.py` | ~20 |
| **MEDIUM** | `extract_user_data()` with 6 provider branches duplicated in 2 files | `auth.py:218-274`, `setup/controller.py:833-888` | ~57 |
| **MEDIUM** | Cache getter functions follow identical pattern x4 | `setting_service.py:188-214` | ~12 |
| **MEDIUM** | YAML config loading pattern repeated 3 times | `asgi.py:83, 165, 648` | ~8 |
| **MEDIUM** | `db_session.add() / commit() / refresh()` pattern across all services | `db/services/*.py` | ~10 |
| **LOW** | Magic string keys for session (`oauth_state`, `oauth_provider`, etc.) | `controllers/auth.py` | — |
| **LOW** | `datetime.now(UTC)` for publication timestamps repeated 3 times | `admin/controller.py:265, 350, 392` | — |
| **LOW** | Exception handler registration identical in both apps | `asgi.py:572-575, 704-706` | — |

**Estimated total reduction: ~200 lines** with focused extraction of shared utilities.

### Recommended Refactoring Priority

1. Extract shared `handle_oauth_login()` utility — eliminates highest duplication
2. Extract `parse_page_form_data(data) -> dict` helper
3. Extract `create_session_config(settings, ...)` factory
4. Add `_render_admin_template()` helper to AdminController
5. Define session key constants at module level

---

## 3. SOLID Principles

| Principle | Rating | Key Issues |
|-----------|--------|------------|
| **Single Responsibility** | 6.5/10 | `AppDispatcher` mixes routing, lifespan, and error handling; `oauth_callback()` is 122 lines handling 3 distinct scenarios |
| **Open/Closed** | 6/10 | Hooks system is excellent; but adding OAuth providers requires modifying 3+ functions with elif branches |
| **Liskov Substitution** | 8.5/10 | Model hierarchy and guard system (`AuthRequirement` base with `__or__`/`__and__`) are well-designed |
| **Interface Segregation** | 6.5/10 | Services are granular; but `AdminController` handles users, pages, settings, and navigation in one class |
| **Dependency Inversion** | 6/10 | Litestar DI used well; but concrete middleware classes hardcoded in `asgi.py`; OAuth providers not abstracted behind interface |

### Key Recommendations

- **Split `AdminController`** into `UserAdminController`, `PageAdminController`, `SettingsAdminController`
- **Abstract OAuth providers** behind a strategy interface — each provider as a class with `get_auth_url()`, `exchange_code()`, `fetch_user_info()`, `extract_user_data()` methods
- **Split `AppDispatcher`** into Router, LifecycleManager, and ErrorHandler
- **Extract OAuth callback logic** into a testable `OAuthAccountService`

---

## 4. Cyclomatic Complexity

| Severity | Function | Location | Est. Complexity | Lines |
|----------|----------|----------|----------------|-------|
| **HIGH** | `oauth_callback()` | `auth.py:356-478` | ~12 | 122 |
| **HIGH** | `setup_oauth_callback()` | `setup/controller.py:615-824` | ~10 | 209 |
| **HIGH** | `AppDispatcher.__call__()` | `asgi.py:314-354` | ~8 | 40 (4-5 nesting levels) |
| **MEDIUM** | `extract_user_data()` | `auth.py:218-274` | ~7 | 57 (6 elif branches) |
| **MEDIUM** | `configuring_status()` | `setup/controller.py:229-296` | ~7 | 67 (nested async generator) |
| **MEDIUM** | `save_database()` | `setup/controller.py:138-193` | ~6 | 55 |
| **MEDIUM** | `save_auth()` | `setup/controller.py:337-391` | ~5 | 54 (nested loops) |
| **MEDIUM** | `_start_main_app_lifespan()` | `asgi.py:269-312` | — | 3 nested async closures with `nonlocal` |
| **LOW-MED** | `Form.validate()` | `forms/core.py:99-156` | ~6 | 57 (5 sequential operations with state mutations) |

### Recommendations

1. Extract OAuth user provisioning to a service — fixes both HIGH findings
2. Refactor `AppDispatcher.__call__()` to use a routing table or strategy
3. Replace `extract_user_data()` elif chain with provider-class dispatch
4. Extract `configuring_status()` step logic into a `SetupConfigurationSteps` class

---

## 5. Architecture & Design Patterns

### Strengths

- **Hooks system** (`lib/hooks.py`) — Excellent async-first WordPress-style design with priority ordering, decorator registration, and proper type safety. Fully extensible without modification (Open/Closed).
- **Template resolver** (`lib/template.py`) — Elegant WordPress-style fallback hierarchy with working directory override support.
- **Guard pattern** (`auth/guards.py`) — Clean composable `AuthRequirement` base with `__or__`/`__and__` operators for combining permissions.
- **Service layer** — Database operations properly separated from controllers with consistent `list_*`, `get_*`, `create_*`, `update_*`, `delete_*` naming.
- **Async correctness** — Proper await usage throughout, good SSE implementation with cleanup in `try/finally`, hooks system correctly awaits both sync and async handlers.
- **AppDispatcher** — Clever setup wizard pattern allowing setup without server restart.

### Concerns

- **Blocking I/O at startup** — Synchronous `open()` / `read_bytes()` in `config.py:87,102` and `asgi.py:83,165,648`. Acceptable since it only runs once at startup, but worth noting.
- **Permission cache TTL** — Module-level, not configurable (`auth/services.py:19-21`).
- **Circular import workaround** — `forms/core.py:147` uses deferred import of hooks to avoid circular dependency.

---

## 6. Error Handling

### Strengths

- Separate handlers for `HTTPException` and general `Exception` with content negotiation
- Error templates support specific codes (`error-404.html`) and generic fallback (`error.html`)
- 500 handler uses generic message, doesn't leak details

### Issues

| Severity | Issue | Location |
|----------|-------|----------|
| **MEDIUM** | Bare `except Exception:` silently swallows crypto/session errors | `lib/exceptions.py:76, 94` |
| **MEDIUM** | Generic `except Exception as e:` in setup database save | `setup/controller.py:191` |
| **MEDIUM** | `check_setup_complete()` catches all exceptions, returns False — can't distinguish "not configured" from "DB error" | `asgi.py:207-214` |
| **LOW** | Missing logging in silent exception handlers | Multiple locations |

### Recommendation

Replace bare `except Exception:` with targeted catches (`ValueError`, `KeyError`, specific crypto exceptions) and add `logger.debug()` for silent failure paths.

---

## 7. Testing Coverage

### Coverage Assessment

| Status | Area | Notes |
|--------|------|-------|
| **No tests** | Admin controller (page mgmt, user mgmt, roles, settings) | ~520 lines untested |
| **No tests** | Auth controller (OAuth flows, all 6 providers) | ~600 lines untested |
| **No tests** | Setup wizard (DB config, auth config, migration runner) | ~500 lines untested |
| **Minimal** | Auth session — only tests `_set_login_session()` helper | 79 lines of tests |
| **Good** | Forms (`test_form_core.py`: 547 lines, `test_form_model.py`: 262 lines) | Comprehensive |
| **Good** | Security headers (`test_security_headers.py`: 477 lines) | Good CSP nonce testing |
| **Good** | Notifications (`test_notifications.py`: 372 lines) | Group key/dismissal logic |
| **Good** | Hooks (`test_hooks.py`: 226 lines) | Thorough |
| **Good** | Rate limiting, markdown, SEO, sitemap, template resolution | Adequate |

### Critical Gaps

1. **Admin controller** — Zero tests for authorization enforcement, CRUD operations, role assignment
2. **Auth controller** — No tests for OAuth callback flow, code exchange, provider-specific user data extraction, safe redirect validation
3. **Setup wizard** — No tests for multi-step configuration, migration running, completion detection

### Recommendation

Prioritize `test_auth_controller.py` (mock httpx for OAuth flows) and `test_admin_controller.py` (test permission guards and CRUD). These cover the highest-risk untested code.

---

## 8. Code Quality

| Aspect | Rating | Notes |
|--------|--------|-------|
| **Type hints** | 85%+ | Models excellent (`Mapped[]`), services good, some gaps in auth helpers |
| **Naming** | Excellent | Consistent PEP 8, descriptive names throughout |
| **Import organization** | Good | stdlib → third-party → local, `TYPE_CHECKING` used correctly |
| **Documentation** | Good | Hooks and template modules have excellent docstrings; services and admin lack module-level docs |

---

## Summary of Recommended Actions

### Priority 1 — Security
1. Disable raw HTML in markdown-it-py or sanitize before `| safe`
2. Require email verification before auto-linking OAuth accounts
3. Add try/except around `datetime.fromisoformat()` in admin forms

### Priority 2 — DRY / Complexity
4. Extract shared OAuth account provisioning utility (~200 lines saved, fixes highest-complexity functions)
5. Extract `parse_page_form_data()` helper
6. Extract session/template/static config factories in `asgi.py`

### Priority 3 — Testing
7. Create `test_auth_controller.py` with OAuth flow mocking
8. Create `test_admin_controller.py` with permission guard tests
9. Create `test_setup_controller.py`

### Priority 4 — Architecture
10. Split `AdminController` into domain-specific controllers
11. Abstract OAuth providers behind strategy interface
12. Replace bare `except Exception:` with targeted catches + logging
